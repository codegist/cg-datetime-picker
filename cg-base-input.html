<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../font-awesome-polymer-icons/fa-icons.html">
<script src="../momentjs/min/moment-with-locales.min.js"></script>

<dom-module id="cg-base-input">
    <style>
        :host {
            @apply(--layout-horizontal);
        }
        #button {
            padding:0px;
        }
        #input {
            width:100%!important;
        }
        #button iron-icon {
            width:18px;
            height:18px;
        }
        input {
            @apply(--layout-flex);
        }
    </style>
    <template>
        <input tabindex="0" is="iron-input" required$="{{required}}" value$="{{formattedDate}}" disabled$="{{disabled}}" on-tap="_openDialog" id="input">
        <paper-icon-button id="button" tabindex="0" icon="fa:calendar-o" on-tap="_openDialog" relative noink disabled$="{{disabled}}"></paper-icon-button>
    </template>
</dom-module>
<script>
    Polymer({
        is:'cg-base-input',
        properties:{
            listensTo:{
                type:Array,
                value:[]
            },
            disabled:{
                type:Boolean,
                value:false,
            },
            required:{
                type:Boolean,
                value:false,
            },
            dateFormat:{
                type:String,
            },
            datetime:{
                type:Date,
                notify:true,
                observer:'datetimeChanged'
            },
            formattedDate:{
                computed:"formatDate(datetime, dateFormat)"
            },
            backdrop:{
                type:Boolean,
                notify:true,
            }
        },
        _pickerDatetime:null,
//        _decoratorElement:null,
        ready:function(){
            console.log()
//            if(this.parentElement.tagName.toLowerCase() == "paper-input-decorator") {
//                this._decoratorElement = this.parentElement; // _decoratorElement thing's quite nasty..
//                this._decoratorElement.input = this.$.input; // _decoratorElement thing's quite nasty..
//            }
        },
        _openDialog: function() {
            if(this.disabled) {
                return;
            }
            //this.datetimeChanged();
            this.$.picker.open(this._pickerDatetime, function(e){
                this.datetime = e.detail;
                this.fire("date-changed", this.datetime);
            }.bind(this), this.backdrop);
//            if(this._decoratorElement) {
//                this.job("refocus", function(){this._decoratorElement.focused = true;}, 250);
//            }
        },
        formatDate:function(date, format){
            return date ? moment(date.toISOString(), moment.ISO_8601).format(format) : undefined;
        },
        format:{
            toModel:function(value, scope){
                var date = moment(value, scope.dateFormat, true);
                if(!date.isValid()) {
                    scope.$.input.setCustomValidity("Date is not valid");
//                    scope._decoratorElement &&  this.async(scope._decoratorElement.inputChanged.bind(scope._decoratorElement));
                }else{
                    this.$.input.setCustomValidity(null);
                }
                return date;
            },
            toDOM:function(value, scope){
                return value ? moment(value.toISOString(), moment.ISO_8601).format(scope.dateFormat) : undefined;
            },
        },
        datetimeChanged: function () {
            this._pickerDatetime = this.datetime ? new Date(this.datetime) : null;
//            this._decoratorElement &&  this.async(this._decoratorElement.inputAction.bind(this._decoratorElement));
        }
    });
</script>