<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../cg-behaviors/cg-base-behavior.html">

<dom-module id="cg-base-value-picker">
    <style>
        :host {
            display: inline-block;
            position: relative;
            width: 300px;
        }

        #container{
            height: 100%;
            width: 100%;
            padding: 0px 9px;
            box-sizing: border-box;
        }

        #container .values {
            overflow:auto;
            @apply(--layout-horizontal);
            @apply(--layout-flex);
            @apply(--layout-wrap);
            @apply(--layout-self-stretch);
        }

        #container .value {
            @apply(--layout-center-justified);
            @apply(--layout-center-center);
            @apply(--paper-font-headline);
            font-size:1.2rem!important;
            color:rgba(0, 0, 0, 0.870588);
            display: block;
            text-align: center;
            margin: 3px;
            line-height: 64px!important;
        }
        #container .value.selected div {
            background-color: #009688;
            border-radius: 100%;
            color: white;
        }

        #container .value[data-value]{
            cursor: pointer;
        }

        #container .value div {
            outline:0;
        }
    </style>
    <template>
        <div on-tap="_selectvalue" id="container">
            <div class="values" id="scroller" style$="[[style('height', height)]]">
                <template is="dom-repeat" items="{{_values}}">
                    <div class$="[[ifEqualsTo(item.n, _currentvalue, 'value selected', 'value')]]" data-value$="[[item.n]]">
                        <div tabindex="0">[[item.name]]</div>
                    </div>
                </template>
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'cg-base-value-picker',
        properties:{
            min:Number,
            max:Number,
            height:{
                type:String,
                value:"200px"
            },
            displayName:Function,
            currentValue:Function,
            toDatetime:Function,
            datetime: {
                type:Date,
                notify:true,
                observer:'datetimeChanged'
            },
        },
        behaviors:[CG.BaseBehavior],
        _values:null,
        _currentvalue:null,
        ready: function(){
            var _values = [];
            for(var i = this.min; i <= this.max; i++){
                _values.push({
                    name:this.displayName(i),
                    n:i
                });
            }
            this._values = _values;
        },
        datetimeChanged: function(){
            this._currentvalue = this.currentValue(this.datetime);
            this.scrollToSelection();
        },
        scrollToSelection:function(){
            this.doWhenConditionIsMet(this._scrollToSelection, function(){return this.$.scroller.offsetWidth != 0}, 250);
        },
        _scrollToSelection:function(){
            var selected = this.$.container.querySelector("div.value[data-value='" + this._currentvalue + "']");
            if(selected) {
                var scrollTop = this.$.scroller.scrollTop;
                var scrollBottom = scrollTop + this.$.scroller.clientHeight;
                var selectedTop = selected.offsetTop;
                var selectedBottom = selectedTop + selected.clientHeight;

                // TODO: This is essentially a interstection detector. Clean that ugly condition to something sound.
                if(
                        (scrollTop > selectedTop && selectedBottom < scrollBottom)
                        ||  (scrollBottom < selectedBottom && selectedTop > scrollTop)
                        ||  (scrollTop > selectedTop && selectedBottom > scrollBottom)) {
                    this.$.scroller.scrollTop = selected.offsetTop - this.$.scroller.clientHeight/2 + selected.clientHeight/2;
                }
            }
        },
        _selectvalue: function(e){
            var data = e.path[1].dataset.value ? e.path[1].dataset : e.path[0].dataset;
            var value = data.value;
            if(value){
                this.datetime = this.toDatetime(value, this.datetime);
                this.fire("date-changed", this.datetime);
            }
        },
    });
</script>
